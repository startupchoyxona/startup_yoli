<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Startup Yoâ€˜li â€” Tap on Time</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark: #02121c;
  --bg-light: #062635;
  --accent: rgb(90,200,150);
  --accent-glow: rgba(90,200,150,0.5);
  --white: #ffffff;
  --text-muted: rgba(255,255,255,0.6);
  --danger: #ff4757;
  --font-main: 'Inter', system-ui, sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

body {
  margin: 0;
  height: 100vh;
  background-color: var(--bg-dark);
  background: radial-gradient(circle at center bottom, var(--bg-light) 0%, var(--bg-dark) 80%);
  font-family: var(--font-main);
  color: var(--white);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* --- SPACE BACKGROUND --- */
#space {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}
.star {
  position: absolute;
  background: white;
  border-radius: 50%;
  opacity: 0.8;
  animation: twinkle var(--dur) ease-in-out infinite;
}
.blind {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(90,200,150,0.2) 30%, transparent 70%);
  filter: blur(8px);
  opacity: 0;
  animation: floatBlind 8s ease-in-out infinite;
}
@keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
@keyframes floatBlind { 0%, 100% { transform: translateY(0) scale(1); opacity: 0.3; } 50% { transform: translateY(-20px) scale(1.2); opacity: 0.6; } }

/* --- GAME CONTAINER --- */
#game-ui {
  position: relative;
  z-index: 10;
  width: 100%;
  max-width: 480px;
  height: 100%;
  max-height: 850px;
  display: flex;
  flex-direction: column;
  padding: 16px;
}

/* HEADER */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  margin-bottom: 10px;
}
.logo-area h1 { margin: 0; font-size: 18px; font-weight: 900; letter-spacing: -0.5px; }
.logo-area p { margin: 0; font-size: 12px; color: var(--text-muted); }
.community-link {
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  font-weight: 700;
  background: rgba(90,200,150,0.1);
  padding: 6px 10px;
  border-radius: 20px;
  border: 1px solid rgba(90,200,150,0.3);
}

/* STAGE BAR */
.stage-track {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
}
.stage-seg {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.stage-fill {
  width: 0%;
  height: 100%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  transition: width 0.3s ease;
}
.stage-names {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  font-weight: 700;
  margin-top: -14px;
  padding: 0 4px;
  margin-bottom: 10px;
}

/* MAIN PLAY AREA */
.main-stage {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
}

/* ROCKET */
.rocket-container {
  position: relative;
  width: 120px;
  height: 120px;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 5;
}
.rocket-img {
  width: 100%;
  height: auto;
  filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
  z-index: 2;
}
.rocket-flame {
  position: absolute;
  bottom: -20px;
  width: 20px;
  height: 40px;
  background: linear-gradient(to bottom, #ff9f43, #ff4757, transparent);
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 1;
  filter: blur(4px);
}
.flying .rocket-flame { opacity: 0.8; animation: flicker 0.1s infinite alternate; }
@keyframes flicker { from { transform: scale(1); } to { transform: scale(1.1) translateY(2px); } }

/* METER (The Game Mechanic) */
.meter-container {
  width: 100%;
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 20px 16px;
  margin: 20px 0;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
}
.meter-bar {
  height: 30px;
  background: #0d1f2b;
  border-radius: 15px;
  position: relative;
  overflow: hidden;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
}
.zone {
  position: absolute;
  top: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
  border-left: 2px solid var(--accent);
  border-right: 2px solid var(--accent);
  width: 15%;
  left: 42.5%; /* Center-ish */
  z-index: 1;
}
.cursor {
  position: absolute;
  top: 2px; bottom: 2px;
  width: 6px;
  background: #fff;
  border-radius: 4px;
  left: 0%;
  z-index: 2;
  box-shadow: 0 0 10px white;
}
.stats {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-muted);
}
.stat-val { color: var(--white); margin-left:4px; }
.timer-val { color: var(--white); font-variant-numeric: tabular-nums; }
.timer-danger { color: var(--danger); animation: pulseRed 0.5s infinite; }

@keyframes pulseRed { 0%,100%{opacity:1;} 50%{opacity:0.6;} }

/* CONTROLS */
.controls {
  width: 100%;
  display: flex;
  gap: 12px;
  flex-direction: column;
}
.btn-main {
  width: 100%;
  background: linear-gradient(180deg, var(--accent) 0%, #3ba87d 100%);
  border: none;
  padding: 20px;
  border-radius: 16px;
  color: #03202e;
  font-size: 20px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 6px 0 #2a7a5b, 0 15px 20px rgba(0,0,0,0.3);
  transition: all 0.1s;
  cursor: pointer;
}
.btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #2a7a5b, 0 5px 10px rgba(0,0,0,0.3); }

.sub-controls { display: flex; gap: 10px; }
.btn-sub {
  flex: 1;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  padding: 12px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
}

/* MESSAGES */
.msg-bubble {
  position: absolute;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  color: #02121c;
  background: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  pointer-events: none;
  z-index: 20;
  max-width: 140px;
  animation: floatUp 1.5s forwards;
  opacity: 0;
}
.msg-good { background: #d1fae5; color: #064e3b; right: 10px; border-bottom-right-radius: 2px; }
.msg-bad { background: #fee2e2; color: #7f1d1d; left: 10px; border-bottom-left-radius: 2px; }

@keyframes floatUp {
  0% { transform: translateY(10px) scale(0.9); opacity: 0; }
  20% { transform: translateY(0) scale(1); opacity: 1; }
  80% { opacity: 1; }
  100% { transform: translateY(-20px); opacity: 0; }
}

/* OVERLAYS */
.overlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(2, 18, 28, 0.95);
  backdrop-filter: blur(10px);
  z-index: 50;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 24px;
  transition: opacity 0.3s;
}
.overlay.hidden { opacity: 0; pointer-events: none; }
.overlay h2 { font-size: 26px; margin-bottom: 8px; color: var(--accent); margin-top:0; }
.overlay p { color: #ccc; line-height: 1.5; margin-bottom: 24px; font-size: 14px; }

/* Name Input */
.input-group { margin-bottom: 20px; width: 100%; max-width: 300px; }
.input-field {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 16px;
  text-align: center;
  outline: none;
}
.input-field:focus { border-color: var(--accent); background: rgba(255,255,255,0.15); }

/* Stats Card */
.stats-card {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  margin-bottom: 20px;
  border: 1px solid rgba(255,255,255,0.1);
}
.stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
.stat-row:last-child { border: none; margin: 0; padding: 0; }
.stat-row span:last-child { font-weight: 700; color: var(--white); }

/* Confetti */
.confetti { position: absolute; width: 8px; height: 8px; background: var(--accent); animation: fall 3s linear forwards; }
@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

</style>
</head>
<body>

<div id="space"></div>

<div id="game-ui">
  <header>
    <div class="logo-area">
      <h1>STARTUP YOâ€˜LI</h1>
      <p>Tap on Time</p>
    </div>
    <a href="https://t.me/startup_choyxona" target="_blank" class="community-link">Startup Choyxona â†—</a>
  </header>

  <!-- Stage Progress -->
  <div class="stage-track">
    <div class="stage-seg"><div class="stage-fill" id="fill-0"></div></div>
    <div class="stage-seg"><div class="stage-fill" id="fill-1"></div></div>
    <div class="stage-seg"><div class="stage-fill" id="fill-2"></div></div>
    <div class="stage-seg"><div class="stage-fill" id="fill-3"></div></div>
    <div class="stage-seg"><div class="stage-fill" id="fill-4"></div></div>
  </div>
  <div class="stage-names">
    <span>Idea</span><span>MVP</span><span>Test</span><span>Marketing</span><span>Invest</span>
  </div>

  <div class="main-stage" id="main-stage-area">
    <div class="rocket-container" id="rocket-con">
      <!-- Simple SVG Rocket -->
      <svg class="rocket-img" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path fill="#e0e0e0" d="M256 16c-60 0-100 80-100 180 0 65 30 110 60 140v80l40 40 40-40v-80c30-30 60-75 60-140 0-100-40-180-100-180z"/>
        <path fill="#ff4757" d="M156 196c-30 30-50 80-50 140 0 60 40 100 40 100s-10-30-10-60c0-30 20-80 20-180z"/>
        <path fill="#ff4757" d="M356 196c30 30 50 80 50 140 0 60-40 100-40 100s10-30 10-60c0-30-20-80-20-180z"/>
        <circle cx="256" cy="160" r="30" fill="#90c896" stroke="#222" stroke-width="8"/>
      </svg>
      <div class="rocket-flame"></div>
    </div>
  </div>

  <div class="meter-container">
    <div class="meter-bar">
      <div class="zone" id="zone"></div>
      <div class="cursor" id="cursor"></div>
    </div>
    <div class="stats">
      <span>Player: <span id="player-display" class="stat-val">...</span></span>
      <span>Deadline: <span id="timer-display" class="timer-val">15.0s</span></span>
    </div>
  </div>

  <div class="controls">
    <button class="btn-main" id="btn-tap">BOSISH ðŸš€</button>
    <div class="sub-controls">
      <button class="btn-sub" id="btn-sound">Ovoz: ON</button>
    </div>
  </div>

  <!-- Start Overlay -->
  <div class="overlay" id="start-screen">
    <div style="font-size: 50px; margin-bottom:10px">ðŸš€</div>
    <h2>Startup Yoâ€˜li</h2>
    <p>Ismingizni kiriting va oâ€˜yinni boshlang.</p>
    <div class="input-group">
      <input type="text" id="username-input" class="input-field" placeholder="Ismingiz" maxlength="12">
    </div>
    <p style="font-size:12px; color:var(--accent); margin-top:-10px; margin-bottom:20px">Yashil zonada bosing â€¢ Vaqtni kuzating</p>
    <button class="btn-main" id="btn-start">Oâ€˜yinni Boshlash</button>
  </div>

  <!-- Win/Fail Overlay -->
  <div class="overlay hidden" id="end-screen">
    <div id="end-icon" style="font-size: 50px; margin-bottom:10px">ðŸŽ‰</div>
    <h2 id="end-title">Tabriklaymiz!</h2>
    <p id="end-msg">Sizning Startapingiz muvaffaqiyatli!</p>

    <div class="stats-card">
      <div class="stat-row"><span>Oâ€˜yinchi</span><span id="end-name">-</span></div>
      <div class="stat-row"><span>Bosqichlar</span><span id="end-stages">-</span></div>
      <div class="stat-row"><span>Urinishlar</span><span id="end-taps">-</span></div>
      <div class="stat-row"><span>Xatolar</span><span id="end-misses">-</span></div>
      <div class="stat-row"><span>Vaqt</span><span id="end-time">-</span></div>
    </div>

    <div style="display:flex; gap:10px; width:100%; flex-direction:column">
      <button class="btn-main" id="btn-restart">Qayta Oâ€˜ynash</button>
      <a href="https://t.me/startup_choyxona" target="_blank" class="btn-sub" style="text-align:center; text-decoration:none; display:block">Telegramga Qoâ€˜shilish</a>
    </div>
  </div>
</div>

<script>
// --- MESSAGES DATA ---
const MESSAGES = {
  0: { // Idea
    good: ["Fikr ajoyib! ðŸ’¡","Investorga tayyor! ðŸ“Š","Brainstorm aâ€™lo ðŸ‘¥","Idea pitch tayyor âœ…","Qiziqish uygâ€˜ondi ðŸ’°","Fikr yozildi ðŸ“","Team motivatsiya ðŸš€","Diagramma tayyor ðŸ“ˆ","Yangi feature âœ¨","Fikr ijobiy ðŸ‘"],
    bad: ["Charchadim ðŸ˜“","Motivatsiya yoâ€˜q ðŸ˜…","Feedback yomon ðŸ˜¢","Prototip qiyin âœï¸","Kod ishlamayapti ðŸ›","Server yoâ€˜q ðŸ–¥ï¸","Code review qoldi ðŸ•’","Deadline stress ðŸ˜¬","Email ketmadi ðŸ“§","CSS buzuq ðŸŽ¨"]
  },
  1: { // MVP
    good: ["Beta ajoyib ðŸ‘","MVP ishlayapti! ðŸš€","Team ishladi ðŸ’ª","Feedback ijobiy ðŸŒŸ","Deploy boâ€˜ldi âœ…","Feature on ðŸŸ¢","Testing zoâ€˜r ðŸ§‘â€ðŸ’»","Bugfix complete ðŸ”§","MVP demo ready ðŸŽ‰","Launch cheers ðŸŽŠ"],
    bad: ["Buglar koâ€˜p ðŸž","Frontend xato ðŸ˜©","Backend bitmadi ðŸ› ï¸","Database crash ðŸ˜±","CSS xato ðŸŽ¨","Login xato ðŸ”´","Server sekin ðŸ¢","Notif ishlamadi ðŸ“µ","Session timeout ðŸ˜¬","API fail ðŸš«"]
  },
  2: { // Test
    good: ["Test passed âœ”ï¸","Auto-test aâ€™lo ðŸ¤–","QA approves âœ…","UI perfect ðŸŽ¨","Stage cleared ðŸš€","Testing zoâ€˜r ðŸ‘¥","Fixes deployed ðŸ”§","All passed ðŸ†","QA feedback ðŸ’ª","Phase done ðŸŽ‰"],
    bad: ["Bug topildi âŒ","Manual qiyin ðŸ˜“","Crash report âš ï¸","UX issue ðŸ˜•","Error log ðŸ˜µ","Timeout â³","Page error ðŸŒ","Data corrupt ðŸ˜¬","Lag detected ðŸ¢","Tests failed âš ï¸"]
  },
  3: { // Marketing
    good: ["Ad started ðŸ“¢","Users engaging ðŸ”¥","Strategy works ðŸ’¡","PR article ðŸ“°","Influencer ðŸ¤","Traffic spikes ðŸ“ˆ","Content ready âœ¨","Leads generated âœ…","Engagement up ðŸ“Š","Stage cleared ðŸŽ‰"],
    bad: ["CTR past ðŸ˜•","Social error ðŸ›‘","Bounce high ðŸ“§","Budget over ðŸ’¸","Ads bad ðŸ˜…","Page broken ðŸ–¥ï¸","Disapproved ðŸš«","Conversion low ðŸ˜“","Negative comments ðŸ˜¬","Analytics down ðŸ“‰"]
  },
  4: { // Invest
    good: ["Meeting set ðŸ“…","Funding offer ðŸ’°","Team excited ðŸš€","SAFE signed âœï¸","Equity done âœ…","Goal hit ðŸŽ¯","Impressive ðŸ˜Ž","Capital raised ðŸ¦","Ready to scale ðŸ“ˆ","Celebration! ðŸŽ‰"],
    bad: ["Rejected ðŸ˜¢","Due diligence ðŸ•’","Investor doubts ðŸ¤”","Review delayed ðŸ›ï¸","Term sheet âŒ","Transfer delay ðŸ’¸","Not convincing ðŸ˜¬","Postponed â³","Feedback critical âš ï¸","Expenses ðŸ˜…"]
  }
};

// --- CONFIGURATION ---
const stages = ['Idea', 'MVP', 'Test', 'Marketing', 'Invest'];
const TOTAL_STAGES = 5;
const TAPS_PER_STAGE = 5;
const BASE_SPEED = 1.1;
const SPEED_INC = 0.25;

// Difficulty Tuning (Bonuses/Penalties in seconds)
// Idea: Easy to gain time. Invest: Hard to gain, easy to lose.
const TIME_CONFIG = [
  { bonus: 3.0, penalty: 2.0 }, // Idea
  { bonus: 2.5, penalty: 3.0 }, // MVP
  { bonus: 2.0, penalty: 4.0 }, // Test
  { bonus: 1.5, penalty: 5.0 }, // Marketing
  { bonus: 1.0, penalty: 6.0 }  // Invest
];

// --- STATE ---
let gameState = {
  active: false,
  stage: 0,
  progress: 0, // taps in current stage
  timer: 15.0,
  totalTime: 0,
  startTime: 0,
  taps: 0,
  misses: 0,
  name: "Player",
  animId: null
};

// Physics
let cursorPos = 0;
let direction = 1;
let speed = 1.0;
let currentZone = { start: 0, end: 0 };
let soundOn = true;

// DOM
const ui = {
  cursor: document.getElementById('cursor'),
  zone: document.getElementById('zone'),
  timer: document.getElementById('timer-display'),
  player: document.getElementById('player-display'),
  fills: [0,1,2,3,4].map(i => document.getElementById(`fill-${i}`)),
  stageArea: document.getElementById('main-stage-area'),
  screens: {
    start: document.getElementById('start-screen'),
    end: document.getElementById('end-screen')
  },
  inputs: {
    name: document.getElementById('username-input')
  },
  endStats: {
    name: document.getElementById('end-name'),
    stages: document.getElementById('end-stages'),
    taps: document.getElementById('end-taps'),
    misses: document.getElementById('end-misses'),
    time: document.getElementById('end-time'),
    title: document.getElementById('end-title'),
    msg: document.getElementById('end-msg'),
    icon: document.getElementById('end-icon')
  }
};

// --- AUDIO ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = new AudioContext();

function playTone(freq, type, duration, vol=0.1) {
  if (!soundOn) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function sfxHit() { playTone(800, 'sine', 0.1); setTimeout(()=>playTone(1200, 'square', 0.1), 80); }
function sfxMiss() { playTone(150, 'sawtooth', 0.3); setTimeout(()=>playTone(100, 'sawtooth', 0.3), 100); }
function sfxStage() { playTone(400, 'sine', 0.2); setTimeout(()=>playTone(600, 'sine', 0.2), 150); setTimeout(()=>playTone(900, 'triangle', 0.6), 300); }

// --- LOGIC ---

function randomizeZone() {
  const diffFactor = gameState.stage * 2;
  const width = Math.max(10, 20 - diffFactor);
  const pos = Math.random() * (90 - width) + 5;
  ui.zone.style.left = pos + '%';
  ui.zone.style.width = width + '%';
  return { start: pos, end: pos + width };
}

function showMessage(type) {
  const msgs = MESSAGES[gameState.stage][type === 'good' ? 'good' : 'bad'];
  const text = msgs[Math.floor(Math.random() * msgs.length)];

  const el = document.createElement('div');
  el.className = `msg-bubble ${type === 'good' ? 'msg-good' : 'msg-bad'}`;
  el.textContent = text;

  // Random vertical pos
  const top = Math.random() * 60 + 10;
  el.style.top = top + '%';

  ui.stageArea.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

function updateTimerDisplay() {
  ui.timer.textContent = gameState.timer.toFixed(1) + 's';
  if (gameState.timer < 5) ui.timer.classList.add('timer-danger');
  else ui.timer.classList.remove('timer-danger');
}

function endGame(won) {
  gameState.active = false;
  cancelAnimationFrame(gameState.animId);

  const endTime = (Date.now() - gameState.startTime) / 1000;

  ui.screens.end.classList.remove('hidden');
  ui.endStats.name.textContent = gameState.name;
  ui.endStats.stages.textContent = won ? "Barchasi (5/5)" : `${stages[gameState.stage]} (${gameState.stage}/5)`;
  ui.endStats.taps.textContent = gameState.taps;
  ui.endStats.misses.textContent = gameState.misses;
  ui.endStats.time.textContent = endTime.toFixed(1) + 's';

  if (won) {
    ui.endStats.title.textContent = "Tabriklaymiz!";
    ui.endStats.msg.textContent = `Startap "Unicorn" darajasiga yetdi! ðŸ¦„`;
    ui.endStats.icon.textContent = "ðŸŽ‰";
    launchConfetti();
    sfxStage();
  } else {
    ui.endStats.title.textContent = "Vaqt Tugadi!";
    ui.endStats.msg.textContent = "Keyingi safar albatta oâ€˜xshaydi.";
    ui.endStats.icon.textContent = "âŒ›";
    sfxMiss();
  }
}

function nextStage() {
  gameState.stage++;
  gameState.progress = 0;

  if (gameState.stage >= TOTAL_STAGES) {
    endGame(true);
    return;
  }

  sfxStage();
  speed = BASE_SPEED + (gameState.stage * SPEED_INC);
  currentZone = randomizeZone();
  updateProgress();

  // Rocket Fly animation
  const r = document.getElementById('rocket-con');
  r.style.transform = "scale(1.2) rotate(-10deg)";
  setTimeout(()=>r.style.transform="scale(1) rotate(0)", 300);
}

function handleTap() {
  if (!gameState.active) return;

  const hit = cursorPos >= currentZone.start && cursorPos <= currentZone.end;
  gameState.taps++;

  if (hit) {
    sfxHit();
    showMessage('good');
    gameState.progress++;
    gameState.timer += TIME_CONFIG[gameState.stage].bonus;

    // Slight rocket pump
    document.getElementById('rocket-con').style.transform = "scale(1.05)";
    setTimeout(()=>document.getElementById('rocket-con').style.transform="scale(1)", 100);

  } else {
    sfxMiss();
    showMessage('bad');
    gameState.misses++;
    gameState.timer -= TIME_CONFIG[gameState.stage].penalty;

    // Shake
    const r = document.getElementById('rocket-con');
    r.style.transform = "translateX(5px)";
    setTimeout(()=>r.style.transform="translateX(-5px)", 50);
    setTimeout(()=>r.style.transform="translateX(0)", 100);

    if(navigator.vibrate) navigator.vibrate(200);
  }

  // Cap timer max? No, let them stack if they are good.

  updateProgress();
  updateTimerDisplay();

  if (gameState.timer <= 0) {
    endGame(false);
    return;
  }

  if (gameState.progress >= TAPS_PER_STAGE) {
    nextStage();
  } else if (hit) {
    currentZone = randomizeZone();
  }
}

function updateProgress() {
  // Update Stage Bars
  ui.fills.forEach((el, i) => {
    if (i < gameState.stage) el.style.width = '100%';
    else if (i === gameState.stage) el.style.width = (gameState.progress / TAPS_PER_STAGE * 100) + '%';
    else el.style.width = '0%';
  });
}

function loop(timestamp) {
  if (!gameState.active) return;

  // Timer Decay logic
  // We subtract frame delta roughly, but for simplicity in this RAF:
  // Let's rely on a precise check next time, but simple subtraction per frame:
  // 60fps -> 0.016s
  gameState.timer -= 0.016;
  if (gameState.timer <= 0) {
    gameState.timer = 0;
    updateTimerDisplay();
    endGame(false);
    return;
  }
  updateTimerDisplay();

  // Cursor Move
  cursorPos += direction * speed;
  if (cursorPos >= 100) { cursorPos = 100; direction = -1; }
  if (cursorPos <= 0) { cursorPos = 0; direction = 1; }
  ui.cursor.style.left = cursorPos + '%';

  gameState.animId = requestAnimationFrame(loop);
}

function startGame() {
  const name = ui.inputs.name.value.trim() || "Founder";
  gameState.name = name;
  ui.player.textContent = name;

  gameState.active = true;
  gameState.stage = 0;
  gameState.progress = 0;
  gameState.timer = 15.0;
  gameState.taps = 0;
  gameState.misses = 0;
  gameState.startTime = Date.now();

  speed = BASE_SPEED;
  currentZone = randomizeZone();
  updateProgress();

  ui.screens.start.classList.add('hidden');
  ui.screens.end.classList.add('hidden');

  // Remove any old confetti
  document.querySelectorAll('.confetti').forEach(e => e.remove());

  gameState.animId = requestAnimationFrame(loop);
}

// --- CONFETTI ---
function launchConfetti() {
  for(let i=0; i<50; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + '%';
    c.style.top = '-10px';
    c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
    c.style.animationDuration = (Math.random()*2 + 2) + 's';
    c.style.animationDelay = (Math.random()*1) + 's';
    document.body.appendChild(c);
  }
}

// --- INIT STARS (Visuals) ---
function initVisuals() {
  const space = document.getElementById('space');
  for(let i=0; i<60; i++) {
    const s = document.createElement('div');
    s.className='star';
    s.style.left=Math.random()*100+'%';
    s.style.top=Math.random()*100+'%';
    s.style.width=Math.random()*2+'px';
    s.style.height=s.style.width;
    s.style.setProperty('--dur',(Math.random()*2+1)+'s');
    space.appendChild(s);
  }
}

// --- EVENTS ---
document.getElementById('btn-start').addEventListener('click', () => {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  startGame();
});

document.getElementById('btn-restart').addEventListener('click', startGame);

document.getElementById('btn-tap').addEventListener('mousedown', (e) => { e.preventDefault(); handleTap(); });
document.getElementById('btn-tap').addEventListener('touchstart', (e) => { e.preventDefault(); handleTap(); });

document.getElementById('btn-sound').addEventListener('click', (e) => {
  soundOn = !soundOn;
  e.target.textContent = "Ovoz: " + (soundOn ? "ðŸ”‰ ON" : "ðŸ”‡ OFF");
});

document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && gameState.active) handleTap();
});

initVisuals();

</script>
</body>
</html>
